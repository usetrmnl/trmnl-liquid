#! /usr/bin/env ruby

require_relative '../lib/trmnl/liquid/version'

`git diff --cached --quiet`
if $?.exitstatus != 0
  puts "‚ùå Working directory is not clean. Aborting."
  exit 1
end

major, minor, patch = TRMNL::Liquid::VERSION.split('.').map(&:to_i)
new_version = ARGV[0] || "#{major}.#{minor}.#{patch + 1}"

puts "‚úÖ Current version: #{TRMNL::Liquid::VERSION}"
puts "‚úÖ Next version:    #{new_version}"

print "‚ö†Ô∏è  This will bump the version, commit, tag, push to GitHub, and release on RubyGems. Continue? [yN] "
if $stdin.gets.chomp.downcase != 'y'
  puts "‚ùå Aborting."
  exit 1
end

template = <<~TEMPLATE
# frozen_string_literal: true
module TRMNL
  module Liquid
    VERSION = "#{new_version}"
  end
end
TEMPLATE

puts "‚úèÔ∏è  Updating version.rb..."
File.write('lib/trmnl/liquid/version.rb', template)

puts "‚úèÔ∏è  Updating Gemfile.lock..."
`bundle install`

puts "üóÑÔ∏è  Committing changes..."
`git add lib/trmnl/liquid/version.rb`
`git add Gemfile.lock`
`git commit -m "v#{new_version}"`

puts "üè∑Ô∏è  Creating v#{new_version} tag..."
`git tag "v#{new_version}"`

puts "‚¨ÜÔ∏è  Pushing to origin..."
`git push origin main --tags`

puts "üéâ Done! v#{new_version} will be live on RubyGems in a few minutes."